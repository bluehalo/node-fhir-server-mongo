<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"
            integrity="sha512-bZS47S7sPOxkjU/4Bt0zrhEtWx0y0CRkhEp8IckzK+ltifIIE9EMIMTuT/mEzoIMewUINruDBIR/jJnbguonqQ=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <title>b.Well FHIR Server</title>
</head>
<body>
<pre></pre>
</body>
<script type="text/javascript">
    $(document).ready(function () {
        const parameters = getUrlVars();

        const authCode = parameters['code'];
        console.log(authCode);
        // get token
        const tokenUrl = parameters['tokenUrl'];

        const data = {
            grant_type: 'authorization_code',
            client_id: parameters['clientId'],
            code: authCode,
            redirect_uri: window.location.origin + '/authcallback'
        };

        const querystring = $.param(data);

        axios.request({
            url: tokenUrl,
            method: 'post',
            data: querystring,
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            }
        }).then(function (res) {
            const accessToken = res.data.access_token;

            setCookie(
                "jwt",
                accessToken,
                60  // expire in 60 minutes
            )

            window.location.assign(parameters['resourceUrl'])

            // axios.request({
            //     url: window.location.origin + parameters['resourceUrl'],
            //     method: 'get',
            //     headers: {
            //         'Authorization': 'Bearer ' + accessToken
            //     }
            // }).then(function (resp) {
            //     $('pre').text(JSON.stringify(resp.data, null, 2));
            // });
        });
    });

    function getUrlVars() {
        let vars = [], hash;
        const hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
        for (let i = 0; i < hashes.length; i++) {
            hash = hashes[i].split('=');
            vars.push(hash[0]);
            vars[hash[0]] = hash[1];
        }
        return vars;
    }

    function setCookie(cookie_name, cookie_value, expirationInMinutes) {
        const d = new Date();
        d.setTime(d.getTime() + (expirationInMinutes * 60 * 1000));
        let expires = "expires=" + d.toUTCString();
        document.cookie = cookie_name + "=" + cookie_value + ";" + expires + ";path=/";
    }
</script>
</html>
