# Contributing
You will need:
1. Docker Desktop: https://docs.docker.com/desktop/mac/install/
2. Node.js 16.13: https://nodejs.org/en/download/releases/ or use brew: https://nodejs.org/tr/download/package-manager/#macos

## Common developer processes

### Run lint
Run `make lint` to do lint checking

### Run unit tests
Run `make tests` to run all the tests locally.  Or click a test in PyCharm and choose "Run test".

### Update packages
To add a new package or update version of a package, edit package.json and then run `make update` to regenerate `yarn.lock` file.

### Bring up FHIR server locally for manual testing
Run `make up` to bring up the fhir server in docker on your local machine.  Click the links shown to access the FHIR server.  You can also use PostMan to make queries to the local FHIR server.

## Project Layout
[.github/](.github/): workflows for Github Actions

[jest/](jest/): configs for jest test runner

[src/dist](src/dist): distribution of assets (css, icons & js) for bootstrap.js

[src/enrich](src/enrich): enrichment handlers that can enrich fhir resources before they are returned to callers

[src/graphql](src/graphql): implements GraphQL schemas and resolvers.  Code-generated by [src/graphql/generator/generate_classes.py](src/graphql/generator/generate_classes.py).  See [graphql.md](graphql.md) for more details.

[src/graphs](src/graphs): GraphDefinition resources for getting a graph (a resources and its related resources) in one call

[src/indexes](src/indexes): Implements adding indexes in mongodb.  When a new collection is created or you use the `/index` endpoint this is called.

[src/lib](src/lib): Helper classes

[src/middleware/](src/middleware/): Node.js Express middleware classes that intercept requests and perforrm some action on it.

[src/oauth](src/oauth): HTML page that is shown when the user is redirected by a OAuth provider

[src/operations](src/operations): Each folder implements a particular operation in FHIR (e.g., get all resources, update a resource etc).  [FHIR Spec](https://www.hl7.org/fhir/operations.html)

[src/routeHandlers](src/routeHandlers): Non-FHIR routes (e.g., logout, show stats)

[src/searchParameters](src/searchParameters): Code-generated information about all the FHIR search parameters (https://www.hl7.org/fhir/searchparameter-registry.html).  Called by r4.js to implement searching.  Code-generation script: [src/searchParameters/generate_search_parameters.py](src/searchParameters/generate_search_parameters.py)

[src/services](src/services): Code-generated route handlers for each FHIR resource.  Code generation script: [src/services/generate_services.py](src/services/generate_services.py)

[src/strategies](src/strategies): Authentication strategies for OAuth.  We use Passport (http://www.passportjs.org/) to implement OAuth.  

[src/tasks](src/tasks): Asynchronous long running tasks that can be kicked off.  These run in a separate process so they are not subject to HTTP request timeouts

[src/tests](src/tests): Unit tests using the jest test runner.  You can generate a new unit test by using the template called FHIR Test.

[src/utils](src/utils): Utility functions called from other code

[src/views](src/views): View templates that are shown when someone access a FHIR resource from a web browser user agent.  Rendered using the middleware: [src/middleware/htmlRenderer.js](src/middleware/htmlRenderer.js).  Currently we use the EJS view engine: https://ejs.co/.  See [renderingViews.md](renderingViews.md) for more details.

[src/app.js](src/app.js): Main entrypoint that sets up the app

[src/app.test.js](src/app.test.js): simple test for the app

[src/config.js](src/config.js): Configuration for the app

[src/constants.js](src/constants.js): Defines constants used in the app

[src/index.js](src/index.js): Implements the main function

[src/profiles.js](src/profiles.js): Specifies the FHIR profiles.  Code-generated by [src/services/generate_services.py](src/services/generate_services.py)

[src/tracing.js](src/tracing.js): Implements tracing to send metrics to Datadog.

[.dockerignore](.dockerignore): files to exclude from docker image

[docker-compose.yml](docker-compose.yml): Docker compose file that brings up this app and related services (e.g., mongo db).  This is only used for local development and NOT in production since we use AWS Managed MongoDB (DocumentDB) in production.

[Dockerfile](Dockerfile): Defines the docker image we run locally AND deploy into production.

[env.json](env.json): Environment variables used when running tests

[jest-mongodb-config.js](jest-mongodb-config.js): Config used when running unit tests

[package.json](package.json): Specifies the npm packages to use and commands for running tests

[package-lock.json](package-lock.json) and [yarn.lock](yarn.lock): Generated from package.json


## Indexing
Indexes are defined here and you can add new ones: 
[customIndexes.js](src/indexes/customIndexes.js)

Indexes are automatically created when a new resource type is added to the server (if the `CREATE_INDEX_ON_COLLECTION_CREATION` environment variable is set).

If you add a new index to an existing collection then you can run indexing by going to `/index/run` url endpoint.


## Index hinting
Some mongo implementations (such as AWS DocumentDB) are not very good at selecting an index to serve a query.  Hence we've added an index hinting feature that compares the columns in the query with the existing indexes and adds a hint to mongo to use that index.  This feature can be turned on by setting the `SET_INDEX_HINTS` environment variable.

## How to add/update custom rendering views
[renderingViews.md](renderingViews.md)
